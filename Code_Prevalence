
### En utilisant le programme Code_Simulation 

## Objectif : calcul de la prévalence d'infarctus du myocarde pour les cohortes de 1920 à 2000 entre 35 et 95 ans

# etats : matrice de 10 000 lignes et 61 colonnes. Avec les individus en ligne et les âges de 35 à 95 ans en colonne implémentant les différents états de 0, 1, 2 et 3
# prev : matrice de 61 lignes et 2 colonnes. Avec les âges en ligne et le nombre de cas en colonne (par cohorte)
# vivants : matrice de 61 lignes et 2 colonnes. Avec les âges en ligne et le nombre de vivant en colonne (par cohorte)


## Package :

library(doParallel)
library(foreach)

cl <- makeCluster(20)
registerDoParallel(cl)


# Fonction générale :

foreach(c=1920:2000) %dopar% {                             # boucle sur les cohortes
  
  etats_<- read.csv(paste("etats",c,sep="_"))              # lecture de la matrice des états pour la cohorte c
  etats$X <- NULL
  colnames(etats) <- gsub("X","",colnames(etats))
  
  prev <- data.frame(matrix(ncol=0,nrow=61))
  vivants <- data.frame(matrix(ncol=0,nrow=61))

  print(c)
  
  for(a in 2:ncol(etats)){                          
    nb = 0
    for(i in 1:nrow(etats)){                               # calcul du nombre de malade (vivant ou décédé)
      if(etats[i,a]==1 |etats[i,a]==3){
        nb <- nb+1
      }
    }
    ligne <- c(a+34,nb)
    prev <- rbind(prev,ligne)
  
    vivant <- 0
    for(i in 1:nrow(etats)){                               # calcul du nombre de personnes vivantes à l'âge a (ou décédé à l'âge a mais vivantes à l'âge a-1) pour la cohorte c
      if(etats[i,a] == 1 | etats[i,a] == 0){
        vivant = vivant +1
      }
      if((etats[i,a] ==2 | etats[i,a]==3) & (etats[i,a-1]==1 | etats[i,a-1]==0)){
        vivant = vivant + 0.5
      }
    }
    ligne <- c(a+34,c,vivant)
    vivants <- rbind(vivants,ligne)
  }
  colnames(prev) <- c("age_maladie","cohorte","prevalence")
  prev$cohorte <- as.factor(prev$cohorte)
  colnames(vivants) <- c("age","cohorte","nb_vivants")
  write.csv(prev_H,file = paste("prev",c,sep="_"))
  write.csv(vivants,file=paste("vivants",c,sep="_"))
}
