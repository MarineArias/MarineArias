

## Objectif : simuler 200 fois, 10 000 individus de leur 35 à 95 ans sur la base d'un modèle illness-death appliqué à l'infarctus du myocarde


# matrice : matrice 10 000 lignes et 4 colonnes. Avec les individus en ligne, l'âge, la cohorte, l'âge auquel l'individu à fait un infarctus du myocarde et l'âge de décès en colonne
# etats : matrice 10 000 lignes et 61 colonnes. Avec les individus en ligne et les âges de 35 à 95 ans en colonne implémentant les différents états de 0, 1, 2 et 3
# état 0 : vivant sain
# état 1 : vivant ayant fait un infarctus du myocarde
# état 2 : mort sans avoir fait d'infarctus ou plus d'un an après l'infarctus
# état 3 : mort durant la première année après avoir fait un infarctus du myocarde
# incidence : matrice contenant les taux d'incidence pour chaque âge et chaque cohorte
# quotient_morta : matrice contenant les quotients de mortalité pour chaque âge et chaque cohorte
# RR1 : risque relatif de mourir au cours de la première année après avoir fait un infarctus du myocarde
# RR2 : risque relatif de mourir plus d'un an après avoir fait un infarctus



## Données (données présentées pour les hommes. A faire varier selon le sexe)

# Quotient de mortalité 
quotient_morta <- read.csv(file="quotients_mortalite_age_cohorte_homme.csv",sep=";",dec=",")
colnames(quotient_morta) <- gsub("Gen","",colnames(quotient_morta))
colnames(quotient_morta) <- c("age",1920:2000)
quotient_morta$age <- NULL


# Risque Relatif
beta1_2 <- read.csv("beta1_2")
beta1_2$X <- NULL
colnames(beta1_2) <- gsub("X","",colnames(beta1_2))


nb_people <- 10000                                         # nombre d'individus simulés par cohorte


## Package
library(doParallel)
library(foreach)

cl <- makeCluster(20)
registerDoParallel(cl)


### Changement d'etats _ fonction generale

T_1 <- Sys.time()

foreach(c=1920:2000) %dopar%{                                     # bouche sur les cohortes
  
  for(it in 1:200) {                                              # boucle sur les itérations
    
    print(it)
    
    incidence <- read.csv(paste("a01_homme",it,sep="_"))          # lecture de la matrice des états pour la cohorte c
    incidence$X <- NULL
    colnames(incidence) <- gsub("X","",colnames(incidence))
    colnames(incidence) <- c(1920:2000)

    matrice <- matrix(c(0),                                       # génération de la matrice des individus
                        nrow = nb_people,
                        ncol = 4)
    colnames(matrice) <- c("age","cohorte","age_maladie","age_deces")
    matrice_H <- as.data.frame(matrice)
      
    n <- 1
    m <- nb_people
    for(ind in n:m){
      matrice[ind,2] <- c
      matrice[ind,1] <- 35
    }
      
    
    etats <- matrix(c(0),                                         # génération de la matrice des états
                      nrow = nb_people,
                      ncol = 81)
    colnames(etats) <- c(35:115)
      
      
    for (a in 2:81){                                              # pour aller de 35 à 95 ans
      print(a+34)
        
      for (i in 1:nrow(etats)){
        age_i <- matrice_H[i,1]
        annee_naiss <- matrice[i,2]
          
        v_incidence <- incidence[a-1,c-1919]  # récupération des taux d'incidence
        mortalite <- quotient_morta[a-1,c-1919]                   # récupération du quotient de mortalité
        

        RR1 <- exp(beta1_2[it,1])                                 # calcul du risque relatif de mourir durant la première année après avoir fait un infarctus du myocarde
        RR2 <- exp(beta1_2[it,2])                                 # calcul du risque relatif de mourir plus d'un an après avoir fait un infarctus
          
        alea <- runif(1,0,1)
         
        if (etats[i,a-1] == 0){                                   # état 0 : vivant sain
          if (alea <= v_incidence){                               # transition : faire un infarctus du myocarde
            etats[i,a] <- 1
            matrice[i,3] <- age_i
              
            alea2 <- runif(1,0,1)
            if (alea2 <= mortalite*RR1){                          # transition : passage à l'état 3 : mourir dans la première année
              etats[i,a] <- 3
              matrice[i,4] <- age_i
            }
          }
            
          alea3 <- runif(1,0,1)
          if (alea3 <= mortalite & alea > v_incidence){           # transition : mourir sans avoir fait d'infarctus du myocarde
            etats[i,a] <- 2
            matrice[i,4] <- age_i
          }
          if (alea3 > mortalite & alea > v_incidence){            # rester sain
            etats[i,a] <- 0
          }
        }
          
        if (etats[i,a-1] == 1){                                   # état 1 : vivant ayant fait un infarctus du myocarde
          morta <- mortalite*RR2
          if (alea > morta){                                      # rester vivant mais malade
            etats[i,a] <- 1
          }
          if (alea <= morta){                                     # transition : mourir en ayant fait un infarctus du myocarde après la première année
            etats[i,a] <- 2
            matrice[i,4] <- age_i
          }
        }
          
        if (etats[i,a-1] == 2){                                   # état 2 : mourir
          etats[i,a] <- 2
        }
          
        if (etats[i,a-1] == 3){                                   # transition : l'individu mort d'un infarctus du myocarde durant la première année passe à mort simple l'année qui suit
          etats[i,a] <- 2
        }
          
        if (matrice[i,1]<=115 & etats[i,a]!= 2){                  # vieillissement de l'individu
          matrice[i,1] <- matrice[i,1] + 1
        }
      }
    }
    write.csv(matrice,file = paste("matrice",c,it,sep="_"))
    write.csv(etats,file = paste("etats",c,it,sep="_"))
  }
}
T_2 <- Sys.time()
Tdiff <- difftime(T_2,T_1)
Tdiff

