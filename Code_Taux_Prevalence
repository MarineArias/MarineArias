
### En utilisant les programmes Code_Simulation et Code_Prevalence

## Objectif : calculer les taux de prévalence par âge pour chaque cohorte

# etats :  matrice de 10 000 lignes et 61 colonnes. Avec les individus en ligne et les âges de 35 à 95 ans en colonne implémentant les différents états de 0, 1, 2 et 3
# prev_H : matrice de 61 lignes et 2 colonnes. Avec les âges en ligne et le nombre de cas en colonne (par cohorte)
# vivants : matrice de 61 lignes et 2 colonnes. Avec les âges en ligne et le nombre de vivant en colonne (par cohorte)
# taux_prev : matrice de 61 lignes et 3 colonnes. Avec les âges en ligne et en colonne la cohorte de référence et les taux de prévalence pour chaque âge (par cohorte)


## Package :
library(doParallel)
library(foreach)

cl <- makeCluster(20)
registerDoParallel(cl)


foreach(c=1920:2000) %dopar% {                             # boucle sur les cohortes
  taux_prev <- data.frame(matrix(ncol=3,nrow=0))
  
  prev <- read.csv(paste("prev",c,sep="_"))                # lecture de la matrice des prévalence pour la cohorte c
  prev$X <- NULL
  colnames(prev) <- gsub("X","",colnames(prev))
  
  vivants <- read.csv(paste("vivants",c,sep="_"))          # lecture de la matrice des vivants pour la cohorte c
  vivants$X <- NULL
  colnames(vivants) <- gsub("X","",colnames(vivants))
  
  for(a in 1:nrow(vivants)){                               # calcul du taux de prévalence par âge pour la cohorte c
    taux_prev[a,1] <- a+34
    taux_prev[a,2] <- c
    taux_prev[a,3] <- (prev[a,3]/vivants[a,3])*100
  }
  colnames(taux_prev) <- c("age","cohorte","taux_prevalence_simulation")
  write.csv(taux_prev,file = paste("taux_prev",c,sep="_"))
}
